---
# $yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json

notify:
  - if: 'build.branch =~ /^((main)|([0-9]+\.[0-9]+))\$/ && (build.state == "failed" || pipeline.started_passing)'
    slack:
      channels:
        - "#search-et-alerts"
      message: "${BUILDKITE_MESSAGE}"

steps:
  - label: "ðŸ”¨ Run e2e test"
    key: "e2e_test"
    agents:
      provider: aws
      instanceType: t3.medium
      imagePrefix: ci-amazonlinux-2023
    command: ".buildkite/run_test.sh"

  - label: "ðŸ”¨ Run FIPS e2e test"
    key: "fips_e2e_test"
    agents:
      provider: aws
      instanceType: t3.medium
      imagePrefix: ci-amazonlinux-2023
    command: ".buildkite/run_fips_test.sh"

  - label: ":whale: Build and publish docker image"
    if: 'build.branch =~ /^((main)|([0-9]+\.[0-9]+))\$/'
    depends_on:
      - "e2e_test"
      - "fips_e2e_test"
    agents:
      image: "docker.elastic.co/ci-agent-images/drivah:0.28.0@sha256:855f50051b589c0da1ee8ce3377eef34dd1cfeb9ef1c0b60518660b6c90517ee"
    command: "scripts/build-and-publish-docker-image.sh --push"
